# 3D 弹珠小游戏（挖坑玩法）需求规格说明书 (SRS)

| 文档版本 | V1.0 |
| :--- | :--- |
| **项目名称** | Vue3 3D Marbles: Pit Master (弹珠大师) |
| **技术栈** | Vue 3 + Three.js + Cannon-es + JavaScript |
| **文档状态** | 草稿 / 评审中 |
| **最后更新** | 2023-10-27 |

---

## 1. 引言 (Introduction)

### 1.1 编写目的
本文档旨在明确"Vue3 3D 弹珠小游戏”的功能需求、非功能需求及技术架构，为开发团队提供统一的执行标准。重点在于实现基于物理引擎的拟真弹珠体验，并完整还原“挖坑”传统玩法规则。

### 1.2 项目背景
利用现代 Web 技术（WebGL）在浏览器端重现传统弹珠游戏。通过 Vue 3 管理游戏状态，Three.js 负责渲染，Cannon-es 负责物理模拟，实现无需下载、即开即玩的 3D 休闲游戏。

### 1.3 适用范围
*   **前端开发**：负责游戏逻辑、UI 交互、3D 场景搭建。
*   **测试人员**：依据本文档进行功能验收和性能测试。
*   **UI/UX 设计**：依据界面需求设计视觉资源。

---

## 2. 总体描述 (Overall Description)

### 2.1 用户特征
*   **目标用户**：休闲游戏玩家，覆盖移动端（手机浏览器）和桌面端。
*   **操作习惯**：习惯触摸屏拖拽或鼠标拖拽操作。

### 2.2 产品视角
本产品为独立运行的 H5 游戏，不依赖后端服务器（单机或本地多人），所有逻辑在客户端运行。

### 2.3 一般约束
*   必须兼容主流现代浏览器（Chrome 90+, Safari 14+）。
*   首屏加载时间不超过 3 秒（资源需压缩）。
*   游戏帧率需稳定在 50FPS 以上（移动端）/ 60FPS（桌面端）。

---

## 3. 功能需求 (Functional Requirements)

### 3.1 游戏核心玩法 (Gameplay)

| 需求 ID | 功能名称 | 详细描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| **FR-01** | **资格赛机制** | 开局所有玩家从起点线弹球。系统计算球静止后距离“第一个坑”的欧几里得距离，最近者获得先手权。 | P0 |
| **FR-02** | **挖坑占领** | 场地设有 3-4 个目标坑（呈直线排列）。玩家需按顺序将球弹入坑中。每占领一个坑，状态更新。 | P0 |
| **FR-03** | **猎人模式** | 当玩家成功占领前 3 个坑后，进入“猎人 (Hunter)"状态。此时该玩家可攻击对手球。 | P0 |
| **FR-04** | **攻击判定** | 猎人状态的球撞击普通状态对手球时，触发攻击效果（对手球重置或暂停一回合）。需通过物理碰撞事件检测。 | P1 |
| **FR-05** | **胜利条件** | 玩家完成所有坑占领，并成功弹入“终点坑”后，游戏结束，显示胜利 UI。 | P0 |
| **FR-06** | **回合切换** | 若玩家未进坑或操作失误，回合自动切换至下一位玩家（或 AI）。 | P0 |

### 3.2 物理与环境 (Physics & Environment)

| 需求 ID | 功能名称 | 详细描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| **FR-07** | **地面摩擦力** | 泥土地面需具备高摩擦力 (`friction > 0.6`) 和低弹性 (`restitution < 0.2`)，确保球能自然停止。 | P0 |
| **FR-08** | **地形起伏** | 地面需包含随机或预设的凸起与小坑（非目标坑），通过 `Heightfield` 实现，影响球的滚动轨迹。 | P1 |
| **FR-09** | **进坑判定** | 目标坑需使用**物理触发器 (Trigger)** 结合速度阈值判定。球速低于阈值且进入触发区视为“进坑成功”，并吸附位置。 | P0 |
| **FR-10** | **碰撞效果** | 球与球、球与地面碰撞需有真实的动量交换。玻璃球之间碰撞需有清脆的音效（可选）。 | P1 |

### 3.3 控制系统 (Controls)

| 需求 ID | 功能名称 | 详细描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| **FR-11** | **拖拽弹射** | 支持鼠标/触摸拖拽。从球体位置向反方向拖拽，显示力度指示线，松手发射。 | P0 |
| **FR-12** | **力度限制** | 设置最大拖拽距离，防止力度过大导致球飞出地图或穿模。 | P1 |
| **FR-13** | **相机跟随** | 相机需平滑跟随当前操作玩家的球，但需限制角度，防止看到地图外或穿地。 | P1 |

---

## 4. 非功能需求 (Non-Functional Requirements)

### 4.1 视觉表现 (Visuals)
*   **NFR-01 玻璃材质**：弹珠必须使用 `MeshPhysicalMaterial`。
    *   `transmission`: 1.0 (透光)
    *   `roughness`: 0.0 (光滑)
    *   `thickness`: 1.5 (折射厚度)
    *   必须加载 HDRI 环境贴图以体现玻璃反射。
*   **NFR-02 光影效果**：开启阴影映射 (`shadowMap`)，主光源模拟太阳光，环境光模拟天光。
*   **NFR-03 视觉反馈**：
    *   目标坑需高亮显示（如发光边缘）。
    *   拖拽时需显示预测轨迹线或力度条。
    *   进坑时需有粒子特效。

### 4.2 性能要求 (Performance)
*   **NFR-04 渲染性能**：Draw Calls 尽量控制在 100 以内。
*   **NFR-05 物理步长**：物理引擎步长固定为 `1/60` 秒，防止高速运动穿模。
*   **NFR-06 内存管理**：游戏结束或重置时，需彻底销毁 Three.js 几何体、材质和 Cannon 刚体，防止内存泄漏。

### 4.3 兼容性 (Compatibility)
*   **NFR-07 响应式布局**：UI 界面需适配手机竖屏、横屏及桌面浏览器。
*   **NFR-08 触摸支持**：必须阻止浏览器默认的触摸滚动行为 (`touch-action: none`)。

---

## 5. 技术架构 (Technical Architecture)

### 5.1 技术栈选型
*   **核心框架**: Vue 3 (Composition API)
*   **3D 渲染**: Three.js (r150+)
*   **物理引擎**: Cannon-es (轻量级，支持 Heightfield)
*   **工具库**: @vueuse/core (处理 RAF 循环、Pointer 事件)
*   **构建工具**: Vite

### 5.2 模块划分
1.  **GameLoop 模块**: 管理 `requestAnimationFrame`，同步物理世界与渲染世界。
2.  **SceneManager 模块**: 负责加载模型、纹理、HDRI，创建地面、坑、弹珠。
3.  **PhysicsManager 模块**: 封装 Cannon-es，管理刚体创建、碰撞事件监听、触发器逻辑。
4.  **InputManager 模块**: 处理拖拽输入，计算发射向量。
5.  **GameState 模块 (Vue Reactive)**: 管理游戏状态机、分数、回合、玩家状态。
6.  **UI 层**: 基于 Vue 的 DOM 组件，覆盖在 Canvas 之上。

### 5.3 关键实现策略
*   **进坑逻辑**：不单纯依赖物理凹陷。在坑位创建 `isTrigger: true` 的 Cannon 刚体。当球体 `collide` 触发器且 `velocity.length < 0.5` 时，强制将球 `position` 设置为坑中心，并锁定速度。
*   **玻璃渲染**：使用 `RGBELoader` 加载 `.hdr` 贴图赋值给 `scene.environment`。
*   **状态同步**：物理计算在 JS 线程，Vue 仅用于存储游戏逻辑状态（如“谁赢了”），避免在渲染循环中频繁触发 Vue 响应式更新。

---

## 6. 数据逻辑与状态机 (Data & State Machine)

### 6.1 游戏状态枚举
```typescript
type GamePhase = 'QUALIFYING' | 'PLAYING' | 'GAMEOVER';
type PlayerStatus = 'NORMAL' | 'HUNTER' | 'FINISHED';
type TurnPhase = 'AIMING' | 'MOVING' | 'RESOLVING';
```

### 6.2 坑位数据结构
```javascript
const holes = [
  { id: 1, pos: {x:0, z:-5}, occupiedBy: null, isFinish: false },
  { id: 2, pos: {x:0, z:-10}, occupiedBy: null, isFinish: false },
  { id: 3, pos: {x:0, z:-15}, occupiedBy: null, isFinish: false },
  { id: 4, pos: {x:0, z:-20}, occupiedBy: null, isFinish: true }  // 终点
];
```

### 6.3 玩家数据结构
```javascript
const players = [
  { id: 1, color: 0xff0000, ballBody: null, status: 'NORMAL', finished: false },
  { id: 2, color: 0x0000ff, ballBody: null, status: 'NORMAL', finished: false } // 或 AI
];
```

---

## 7. 界面与交互设计 (UI/UX)

### 7.1 游戏内 HUD
*   **顶部**：当前回合指示器（显示玩家头像/颜色）、剩余坑位数。
*   **底部**：操作提示（“拖拽发射”）、重置按钮。
*   **场景内**：
    *   力度指示线（拖拽时显示）。
    *   目标坑高亮圈（当前需要进入的坑）。

### 7.2 弹窗界面
*   **开局弹窗**：显示“资格赛”规则，点击开始。
*   **结算弹窗**：显示胜利者，提供“再来一局”按钮。
*   **攻击提示**：当玩家进入“猎人”状态时，弹出短暂提示“可以攻击对手了！”。

---

## 8. 验收标准 (Acceptance Criteria)

1.  **物理验收**：
    *   球在泥土地面滚动应在 3-5 秒内自然停止。
    *   球进入坑位后不会因物理抖动自动滚出。
    *   玻璃球在光照下有明显的折射和反射效果。
2.  **玩法验收**：
    *   资格赛能准确判断谁离坑最近。
    *   必须按顺序进坑，不能跳过中间坑直接进终点。
    *   只有占领 3 坑后才能触发攻击逻辑。
3.  **性能验收**：
    *   移动端连续游玩 5 分钟无明显发热卡顿。
    *   切换场景/重置游戏后内存无明显增长。

---

## 9. 风险评估与对策 (Risks & Mitigation)

| 风险点 | 描述 | 应对策略 |
| :--- | :--- | :--- |
| **物理穿模** | 高速运动下球穿过地面或坑壁 | 限制最大发射力度；开启 Cannon 的 CCD (连续碰撞检测) 或减小物理步长。 |
| **进坑误判** | 球滚过坑上方被判定为进坑 | 增加速度阈值判定；触发器高度略低于地面平面。 |
| **移动端兼容** | iOS Safari WebGL 性能差 | 降低阴影分辨率；简化玻璃材质（减少折射计算）；提供“低画质”选项。 |
| **状态不同步** | 物理停止判断与 UI 状态不一致 | 以物理引擎的 `sleep` 事件或速度阈值为准，统一由 GameLoop 调度状态更新。 |

---

**批准人签字**: ____________________
**日期**: ____________________